---
title: HTTP 緩存機制
tags: [HTTP]
---

## HTTP 緩存

### What
HTTP 緩存是一種優化系統性能的利器，能夠將使用 HTTP 請求獲得到的資料儲存起來，等到下次請求時復用。  
減少多次的 HTTP 請求 - 應答的成本，減少網路帶寬及增加響應速度。    

### Why
假如資料沒有變動過的話, 重複請求相同資料非常浪費網路資源，所以使用緩存將其儲存起來，再次取得資源時響應速度也會比直接從服務端請求快上許多。  

### How
HTTP 緩存又分為強緩存及協商緩存  

#### 強緩存
- expires  
  為HTTP 1.0 新增的 `header`，使用 `<http-date>` 日期格式來判斷緩存到期時間，是絕對時間。
  ```
    expires: Wed, 21 Oct 2015 07:28:00 GMT
  ```
  在 `response header` 中設置 `expires` 字段後，就可以告訴瀏覽器該資源在過期之前可以不用請求。   
  但是缺點為：
    1. 由於是絕對時間，若使用者修改本地時間的話，可能會造成緩存過期而導致失效。  
       就算未修改本地時間，依照時區或其他因素也可能導致客戶端與服務端時間不一致，導致緩存失效。  
    2. 日期格式太過複雜，填寫未符合規定的話緩存即無用。  
- cache-control  
  為了彌補 `expires` 使用絕對時間的不足，在 HTTP 1.1 時新增該 `header`， 表示緩存最大的有效時間，瀏覽器也能發送。
  ```
   cache-control: max-age: 86400 // 能夠緩存24小時
  ```
  還有其他可選的字段能夠設置 (混合使用) :

  - max-age : 資源的有效使用期限 `秒` 為單位，但是這個有效期限是在響應報文離開服務端的時刻，而不是客戶端接收到報文時，也就是說包含傳輸過程中所耗費的時間。  
  - no-store : 不使用緩存，即每次都會去服務器請求資料
  - no-cache : 使用緩存，但每次使用前都會與服務器驗證是否過期與是否有新版本
  - must-revalidate : 使用緩存，只要不過期的話就能繼續使用，過期時就必須去服務器驗證
  - public : 所有內容都可以被緩存 (包含客戶端和代理服務器)
  - private : 只有客戶端內容可以被緩存, 為默認值

在重整(F5) 瀏覽器時會夾帶 `cache-control: max-age:0`，代表資料保存期限已過，需要重新抓取資料。  
而強制重整則是帶 `cache-control: no-cache`。  

疑問是： 兩者含義基本一樣，但差別在哪呢？  
在強制重整時，瀏覽器不會攜帶條件請求(待會介紹)，導致從服務器請求時資源時不會被條件請求所緩存住，而向服務器請求最新的資料。  

而瀏覽器的 `前進`、`後退` 按鈕則不會攜帶 `cache-control`，所以會去檢查緩存。  


#### 協商緩存 (條件請求)
上面提到強緩存有時需要去服務器驗證是否有最新資源，但是強緩存本身並無法執行驗證這個動作，所以定義了條件請求字段，專門用來驗證資源是否過期，而驗證責任則由服務器端負責。  

  - Last-Modified : 資源最後一次被修改的時間，由服務端設定 `response header`。 
   ```
   Last-Modified : Mon, 10 Nov 2018 09:10:11 GMT
   ```
  - If-Modified-Since : 客戶端會將上次服務端 `Last-Modified` 的值存到該字段中，目的用來給服務端驗證資源是否有更新過，若字段對比相同，則回應 `304` 狀態碼，反之則回 `200`。
  - ETag : 是資源的唯一標示，能夠精準的識別資源的變動情況。主要用來解決修改時間無法精準區分文件變化的問題，優先值高於 `Last-Modified`。 
    - 強ETag : 要求資源字節級別必須完全相等 。 
    - 弱ETag : 只要求資源語意上沒有變化，但內部可能會有部份發生改變(空格或者HTML標籤順序調整)。 
  - If-None-Match : 與 `If-Modified-Since` 行為大致相同，只是判斷的字段變成 `ETag`。 

使用協商緩存並不代表不會發送 HTTP 請求，其優化的部分在於若有緩存，則不攜帶 `body` 內容，從而節省網路帶寬。  

## 參考
- [一文读懂前端缓存](https://mp.weixin.qq.com/s/cUqkG3NETmJbglDXfSf0tg)